<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ProfitAdvisor AI - Profit Leak Calculator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'applova-red': '#DC2626',
                        'applova-dark-red': '#B91C1C',
                    },
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #F3F4F6;
        }

        .chat-bubble-bot {
            background-color: #FFFFFF;
            color: #1F2937;
            border-top-left-radius: 0;
            border-top-right-radius: 1rem;
            border-bottom-right-radius: 1rem;
            border-bottom-left-radius: 1rem;
            padding: 1rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            max-width: 85%;
            margin-bottom: 1rem;
            border: 1px solid #E5E7EB;
        }

        .chat-bubble-user {
            background-color: #DC2626;
            color: #FFFFFF;
            border-top-left-radius: 1rem;
            border-top-right-radius: 0;
            border-bottom-right-radius: 1rem;
            border-bottom-left-radius: 1rem;
            padding: 1rem;
            box-shadow: 0 4px 6px -1px rgba(220, 38, 38, 0.2), 0 2px 4px -1px rgba(220, 38, 38, 0.1);
            max-width: 85%;
            margin-bottom: 1rem;
            margin-left: auto;
        }

        .input-field {
            width: 100%;
            padding: 1rem;
            border: 2px solid #E5E7EB;
            border-radius: 0.75rem;
            outline: none;
            transition: border-color 0.2s;
        }

        .input-field:focus {
            border-color: #DC2626;
        }

        .btn-primary {
            background-color: #DC2626;
            color: white;
            font-weight: 600;
            padding: 1rem;
            border-radius: 0.75rem;
            width: 100%;
            transition: background-color 0.2s;
        }

        .btn-primary:hover {
            background-color: #B91C1C;
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1; 
        }
        ::-webkit-scrollbar-thumb {
            background: #d1d5db; 
            border-radius: 3px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #9ca3af; 
        }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <!-- HEADER -->
    <header class="bg-white shadow-sm z-10 p-4">
        <div class="max-w-3xl mx-auto">
            <div class="flex items-center justify-between mb-3">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 bg-applova-red rounded-lg flex items-center justify-center text-white font-bold text-xl">
                        P
                    </div>
                    <div>
                        <h1 class="font-bold text-gray-900 text-lg leading-tight">ProfitAdvisor AI</h1>
                        <p class="text-xs text-gray-500">Profit Leak Quantifier</p>
                    </div>
                </div>
                <div class="flex items-center gap-2 bg-green-50 px-3 py-1 rounded-full border border-green-100">
                    <span class="relative flex h-2.5 w-2.5">
                        <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                        <span class="relative inline-flex rounded-full h-2.5 w-2.5 bg-green-500"></span>
                    </span>
                    <span class="text-xs font-semibold text-green-700">Live Analysis</span>
                </div>
            </div>
            
            <!-- PROGRESS BAR -->
            <div class="w-full bg-gray-100 rounded-full h-2.5">
                <div id="progressBar" class="bg-applova-red h-2.5 rounded-full transition-all duration-500 ease-out" style="width: 0%"></div>
            </div>
        </div>
    </header>

    <!-- CHAT CONTAINER -->
    <main id="chatContainer" class="flex-1 overflow-y-auto p-4 bg-gray-50">
        <div class="max-w-3xl mx-auto flex flex-col" id="messagesArea">
            <!-- Messages will be injected here -->
        </div>
    </main>

    <!-- INPUT AREA -->
    <footer class="bg-white border-t border-gray-100 p-4 z-10">
        <div class="max-w-3xl mx-auto" id="inputArea">
            <!-- Dynamic inputs will be injected here -->
        </div>
    </footer>

    <!-- CONFIRMATION MODAL -->
    <div id="confirmationModal" class="hidden fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50 transition-opacity duration-300">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm text-center transform transition-all duration-300 scale-100">
            <svg class="w-16 h-16 mx-auto text-applova-red mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <h2 class="text-2xl font-bold text-gray-800 mb-2">Report Delivered!</h2>
            <p class="text-sm text-gray-600 mb-4">Your detailed <strong>Profit Recovery Report</strong> has been sent to:</p>
            <p id="modalEmail" class="text-lg font-semibold text-applova-red mb-6 break-all"></p>
            
            <p class="text-sm font-medium text-gray-700 mb-2">Applova is ready to help you recover:</p>
            <p id="modalRecoveryAmount" class="text-3xl font-extrabold text-applova-red mb-6"></p>

            <button onclick="closeModal()" class="w-full bg-applova-red hover:bg-red-700 text-white font-bold py-3 rounded-xl transition duration-200">
                Close & Check Email
            </button>
        </div>
    </div>

    <script>
        // --- 1. CONSTANTS & CONFIGURATION ---
        const TPD_FEE = 0.035; // 3.5%
        const APPLOVA_FEE = 0.029; // 2.9%
        const LTV_UPLIFT_FACTOR = 0.4; // 40%
        const ANNUAL_MONTHS = 12;
        const RECOVERY_EFFICIENCY = 0.95; // 95%

        const STATE_MACHINE = {
            intro: {
                next: 'business_type',
                prompt: "Welcome! I'm your ProfitAdvisor AI. I specialize in quantifying the hidden costs of third-party apps. Ready to see your Annual Profit Leak?",
                inputType: 'button',
                buttonText: 'Start Recovery Now'
            },
            business_type: {
                next: 'aov',
                prompt: "To better tailor your analysis, what best describes your primary business type?",
                inputType: 'select',
                options: ['QSR', 'Fast Casual', 'Full Service', 'Other']
            },
            aov: {
                next: 'orders',
                prompt: "Excellent. What is your typical <strong>average order value (AOV)</strong> for third-party orders? (e.g., 35.50)",
                inputType: 'numeric_float',
                validation: (val) => parseFloat(val) > 0
            },
            orders: {
                next: 'commission',
                prompt: "Roughly, how many <strong>third-party delivery orders</strong> do you process per month? (e.g., 400)",
                inputType: 'numeric_int',
                validation: (val) => parseInt(val) > 0
            },
            commission: {
                next: 'fixed_fees',
                prompt: "We need the primary pain point: What is the estimated <strong>commission rate</strong> you pay (e.g., 25, 30)? Please enter as a whole number (%).",
                inputType: 'numeric_float',
                validation: (val) => parseFloat(val) > 0 && parseFloat(val) <= 50
            },
            fixed_fees: {
                next: 'third_party_apps',
                prompt: "Great point! We must include hidden fees. Do you pay any <strong>monthly fixed platform fees</strong> (e.g., subscription, marketing fee) to third-party apps? (e.g., 100)",
                inputType: 'numeric_float',
                validation: (val) => parseFloat(val) >= 0
            },
            third_party_apps: {
                next: 'email',
                prompt: "Got it. Which third-party delivery apps do you currently use?",
                inputType: 'multi_select',
                options: ['DoorDash', 'Uber Eats', 'Grubhub', 'SkipTheDishes/Other'],
                validation: (val) => val && val.length > 0
            },
            email: {
                next: 'result',
                prompt: "I have all the numbers needed to calculate your total Leak! To generate and email you the full <strong>Profit Recovery Report</strong> with the breakdown, what is your best email address?",
                inputType: 'email',
                validation: (val) => /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(val)
            },
            result: {
                next: null,
                prompt: null, // Handled by displayResults
                inputType: 'none'
            }
        };

        const STEP_KEYS = Object.keys(STATE_MACHINE);
        
        // --- 2. STATE MANAGEMENT ---
        let currentState = 'intro';
        let userData = {};
        let calculationResult = null;

        // --- 3. DOM ELEMENTS ---
        const chatContainer = document.getElementById('chatContainer');
        const messagesArea = document.getElementById('messagesArea');
        const inputArea = document.getElementById('inputArea');
        const progressBar = document.getElementById('progressBar');
        const confirmationModal = document.getElementById('confirmationModal');
        const modalEmail = document.getElementById('modalEmail');
        const modalRecoveryAmount = document.getElementById('modalRecoveryAmount');

        // --- 4. CORE LOGIC ---

        function updateProgressBar() {
            const currentIndex = STEP_KEYS.indexOf(currentState);
            const totalSteps = STEP_KEYS.length;
            // Ensure it reaches 100% at result
            const percentage = Math.min(100, (currentIndex / (totalSteps - 1)) * 100);
            progressBar.style.width = `${percentage}%`;
        }

        function addMessage(text, sender) {
            const div = document.createElement('div');
            div.className = sender === 'bot' ? 'flex justify-start' : 'flex justify-end';
            
            const bubble = document.createElement('div');
            bubble.className = sender === 'bot' ? 'chat-bubble-bot' : 'chat-bubble-user';
            bubble.innerHTML = text; // Allow HTML for bolding
            
            div.appendChild(bubble);
            messagesArea.appendChild(div);
            
            // Scroll to bottom
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function handleInput(value) {
            // Validate
            const config = STATE_MACHINE[currentState];
            if (config.validation && !config.validation(value)) {
                // Shake animation or error message could go here
                alert("Please enter a valid value.");
                return;
            }

            // Save Data
            if (currentState === 'business_type') userData.business_type = value;
            if (currentState === 'aov') userData.aov = parseFloat(value);
            if (currentState === 'orders') userData.orders = parseInt(value);
            if (currentState === 'commission') userData.commission = parseFloat(value);
            if (currentState === 'fixed_fees') userData.monthly_fixed_fee = parseFloat(value);
            if (currentState === 'third_party_apps') userData.third_party_apps = value;
            if (currentState === 'email') userData.email = value;

            // Display User Message
            let displayValue = value;
            if (Array.isArray(value)) displayValue = value.join(', ');
            if (currentState !== 'intro') { // Don't show "Start" button click as message if preferred, but usually good to show
                 addMessage(displayValue, 'user');
            }

            // Transition
            currentState = config.next;
            updateProgressBar();
            
            if (currentState === 'result') {
                displayResults();
            } else {
                renderState();
            }
        }

        function renderState() {
            const config = STATE_MACHINE[currentState];
            
            // Show Bot Prompt
            // Simulate typing delay?
            setTimeout(() => {
                addMessage(config.prompt, 'bot');
                renderInput(config);
            }, 500);
        }

        function renderInput(config) {
            inputArea.innerHTML = ''; // Clear previous inputs

            if (config.inputType === 'button') {
                const btn = document.createElement('button');
                btn.className = 'btn-primary';
                btn.textContent = config.buttonText;
                btn.onclick = () => handleInput('Start');
                inputArea.appendChild(btn);
            } 
            else if (config.inputType === 'select') {
                const grid = document.createElement('div');
                grid.className = 'grid grid-cols-2 gap-2';
                config.options.forEach(opt => {
                    const btn = document.createElement('button');
                    btn.className = 'bg-white border-2 border-red-100 text-applova-red font-medium py-3 px-4 rounded-lg hover:bg-red-50 hover:border-red-200 transition-colors';
                    btn.textContent = opt;
                    btn.onclick = () => handleInput(opt);
                    grid.appendChild(btn);
                });
                inputArea.appendChild(grid);
            }
            else if (config.inputType === 'multi_select') {
                const container = document.createElement('div');
                container.className = 'space-y-3';
                
                const grid = document.createElement('div');
                grid.className = 'grid grid-cols-2 gap-2';
                
                let selected = [];
                
                config.options.forEach(opt => {
                    const btn = document.createElement('button');
                    btn.className = 'py-3 px-4 rounded-lg border-2 font-medium transition-colors bg-white border-gray-200 text-gray-700 hover:border-red-200';
                    btn.textContent = opt;
                    btn.onclick = () => {
                        if (selected.includes(opt)) {
                            selected = selected.filter(s => s !== opt);
                            btn.className = 'py-3 px-4 rounded-lg border-2 font-medium transition-colors bg-white border-gray-200 text-gray-700 hover:border-red-200';
                        } else {
                            selected.push(opt);
                            btn.className = 'py-3 px-4 rounded-lg border-2 font-medium transition-colors bg-applova-red border-applova-red text-white';
                        }
                    };
                    grid.appendChild(btn);
                });
                
                const confirmBtn = document.createElement('button');
                confirmBtn.className = 'btn-primary';
                confirmBtn.textContent = 'Confirm Selection';
                confirmBtn.onclick = () => {
                    if (selected.length > 0) handleInput(selected);
                    else alert("Please select at least one option.");
                };
                
                container.appendChild(grid);
                container.appendChild(confirmBtn);
                inputArea.appendChild(container);
            }
            else if (['numeric_float', 'numeric_int', 'email'].includes(config.inputType)) {
                const form = document.createElement('form');
                form.className = 'flex gap-2';
                form.onsubmit = (e) => {
                    e.preventDefault();
                    const val = input.value;
                    if (val) handleInput(val);
                };

                const input = document.createElement('input');
                input.className = 'input-field';
                input.placeholder = 'Type your answer...';
                input.type = config.inputType === 'email' ? 'email' : 'number';
                if (config.inputType === 'numeric_float') input.step = '0.01';
                input.autofocus = true;

                const btn = document.createElement('button');
                btn.type = 'submit';
                btn.className = 'bg-applova-red text-white p-4 rounded-lg hover:bg-applova-dark-red transition-colors';
                btn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M6 12L3.269 3.126A59.768 59.768 0 0121.485 12 59.77 59.77 0 013.27 20.876L5.999 12zm0 0h7.5" /></svg>`;

                form.appendChild(input);
                form.appendChild(btn);
                inputArea.appendChild(form);
                
                // Focus input
                setTimeout(() => input.focus(), 100);
            }
        }

        // --- 5. CALCULATION LOGIC ---
        function calculateProfitLeak() {
            const { aov, orders, commission, monthly_fixed_fee } = userData;
            
            const annual_commission_loss = (aov * orders * (commission / 100)) * ANNUAL_MONTHS;
            const annual_payment_fee_leak = (aov * orders * ANNUAL_MONTHS) * (TPD_FEE - APPLOVA_FEE);
            const annual_fixed_fee_loss = monthly_fixed_fee * ANNUAL_MONTHS;
            const lclv = (aov * orders * ANNUAL_MONTHS) * LTV_UPLIFT_FACTOR;
            
            const total_annual_leak = annual_commission_loss + annual_payment_fee_leak + lclv + annual_fixed_fee_loss;
            const recovery_amount = ((annual_commission_loss + annual_payment_fee_leak + annual_fixed_fee_loss) * RECOVERY_EFFICIENCY) + lclv;

            return {
                annual_commission_loss,
                annual_payment_fee_leak,
                annual_fixed_fee_loss,
                lclv,
                total_annual_leak,
                recovery_amount
            };
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }).format(amount);
        }

        function displayResults() {
            inputArea.innerHTML = ''; // Clear inputs
            
            const metrics = calculateProfitLeak();
            calculationResult = metrics; // Store for modal

            // 1. Shocker Box
            const shockerHTML = `
                <div class="bg-gradient-to-br from-red-600 to-red-800 rounded-2xl p-6 text-white text-center shadow-xl mb-6 transform transition-all duration-500 scale-100">
                    <h2 class="text-xl font-medium opacity-90 mb-2">Total Annual Profit Leak</h2>
                    <div class="text-5xl font-extrabold mb-2 tracking-tight">
                        ${formatCurrency(metrics.total_annual_leak)}
                    </div>
                    <div class="w-full h-px bg-white/20 my-4"></div>
                    <div class="space-y-1">
                        <p class="text-sm font-medium opacity-90">Applova Estimated Recovery</p>
                        <p class="text-3xl font-bold text-green-300">
                            ${formatCurrency(metrics.recovery_amount)}
                        </p>
                    </div>
                </div>
            `;
            
            // 2. Breakdown Visualization
            const breakdownHTML = renderProfitBreakdown(metrics);

            // 3. Final CTA
            const ctaHTML = `
                <div class="mt-6">
                    <button onclick="showModal()" class="w-full bg-applova-red hover:bg-applova-dark-red text-white font-bold py-4 rounded-xl shadow-lg transition duration-200 flex items-center justify-center gap-2 text-lg animate-pulse">
                        <span>Schedule My Profit Recovery Consultation</span>
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M13.5 4.5L21 12m0 0l-7.5 7.5M21 12H3" />
                        </svg>
                    </button>
                    <p class="text-xs text-center text-gray-500 mt-3">
                        Free 15-min strategy session. No obligation.
                    </p>
                </div>
            `;

            // Add to chat
            const resultContainer = document.createElement('div');
            resultContainer.innerHTML = shockerHTML + breakdownHTML + ctaHTML;
            messagesArea.appendChild(resultContainer);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function renderProfitBreakdown(metrics) {
            const total = metrics.total_annual_leak;
            
            const items = [
                { name: 'Commission Loss', value: metrics.annual_commission_loss, color: 'bg-red-500' },
                { name: 'Payment Fee Leak', value: metrics.annual_payment_fee_leak, color: 'bg-orange-500' },
                { name: 'Fixed Fee Loss', value: metrics.annual_fixed_fee_loss, color: 'bg-yellow-500' },
                { name: 'Lost Customer Value', value: metrics.lclv, color: 'bg-gray-800' }
            ];

            let html = `
                <div class="p-4 bg-white rounded-xl shadow-lg mt-4 border border-gray-100">
                    <h3 class="text-md font-bold text-gray-800 mb-3">Leak Breakdown Visualization</h3>
            `;

            items.forEach(item => {
                const percentage = Math.max(1, Math.round((item.value / total) * 100)); // Min 1% for visibility
                html += `
                    <div class="mb-3">
                        <div class="flex justify-between text-xs text-gray-700 font-medium mb-1">
                            <span>${item.name}</span>
                            <span>${formatCurrency(item.value)} (${percentage}%)</span>
                        </div>
                        <div class="w-full bg-gray-100 rounded-full h-2.5">
                            <div class="${item.color} h-2.5 rounded-full transition-all duration-1000 ease-out" style="width: ${percentage}%"></div>
                        </div>
                    </div>
                `;
            });

            html += `
                    <div class="mt-4 pt-3 border-t border-gray-200 text-sm font-bold flex justify-between text-gray-900">
                        <span>TOTAL ANNUAL LEAK:</span>
                        <span>${formatCurrency(total)}</span>
                    </div>
                </div>
            `;

            return html;
        }

        // --- 6. MODAL LOGIC ---
        function showModal() {
            modalEmail.textContent = userData.email;
            modalRecoveryAmount.textContent = formatCurrency(calculationResult.recovery_amount);
            confirmationModal.classList.remove('hidden');
            
            // Log to console (CRM Hand-off simulation)
            console.log("CRM PAYLOAD:", {
                lead_source: "ProfitAdvisor_Chatbot_V2",
                ...userData,
                metrics: calculationResult
            });
        }

        function closeModal() {
            confirmationModal.classList.add('hidden');
        }

        // --- 7. INITIALIZATION ---
        function init() {
            renderState();
        }

        // Start
        init();

    </script>
</body>
</html>
